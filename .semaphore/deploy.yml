version: v1.0

name: Deploy

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

execution_time_limit:
  minutes: 6

blocks:
  - name: Hugo
    task:
      secrets:
        - name: web1
      prologue:
        commands:
          - apt-get update && apt-get install -y wget
          - wget "https://github.com/gohugoio/hugo/releases/download/v0.54.0/hugo_extended_0.54.0_Linux-64bit.tar.gz"
          - tar zxvf "hugo_extended_0.54.0_Linux-64bit.tar.gz"
          - mv hugo /usr/local/bin

          - chmod 0600 ~/.keys/*
          - ssh-add ~/.keys/*

          - checkout
      jobs:
        - name: Build and push
          commands:
            - hugo -v
            - scp -r public/ deploy@$IP:/usr/local/openresty/nginx/www/fibraclick-wiki/deploy-cache

  - name: web1
    task:
      secrets:
        - name: web1
      prologue:
        commands:
          - chmod 0600 ~/.keys/*
          - ssh-add ~/.keys/*

          - checkout
      jobs:
        - name: SSH
          commands:
            - ssh deploy@$IP REVISION=$SEMAPHORE_GIT_SHA 'bash -s' < .semaphore/deploy.sh
